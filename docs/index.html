<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro Biofertility - Compilazione Documenti PMA</title>
    <!-- Librerie CDN per GitHub Pages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .logo {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .github-badge {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #3498db;
            text-align: center;
        }

        .github-badge h3 {
            color: #2980b9;
            margin-bottom: 5px;
        }

        .form-section {
            background: white;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .form-column {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .form-column h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
        }

        .form-column h3 .icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .documents-section {
            background: white;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .documents-section h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.6em;
            text-align: center;
        }

        .document-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .document-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .document-item:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .document-item.selected {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .document-item input[type="checkbox"] {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 22px;
            height: 22px;
            cursor: pointer;
        }

        .document-item label {
            display: block;
            cursor: pointer;
            padding-right: 40px;
        }

        .document-code {
            font-weight: 700;
            color: #2196f3;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .document-name {
            color: #555;
            font-size: 0.95em;
        }

        .required {
            color: #e74c3c;
        }

        .optional-tag {
            display: inline-block;
            background: #95a5a6;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            margin-left: 5px;
        }

        .actions {
            text-align: center;
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
        }

        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .btn-secondary:hover {
            background: #bdc3c7;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #2c3e50;
            font-size: 1.2em;
            font-weight: 600;
        }

        .progress-bar {
            width: 300px;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px auto 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db 0%, #2980b9 100%);
            width: 0;
            transition: width 0.3s ease;
        }

        .message {
            padding: 15px 25px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .privacy-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
            text-align: center;
        }

        .privacy-notice h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .privacy-notice p {
            color: #856404;
            font-size: 0.95em;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-section, .documents-section, .github-badge {
            animation: fadeIn 0.6s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üè•</div>
            <h1>Centro Biofertility</h1>
            <p>Sistema Web di Compilazione Documenti PMA</p>
        </div>

        <div class="github-badge">
            <h3>üåê Versione Web - GitHub Pages</h3>
            <p>Sistema ottimizzato per funzionare completamente online senza file esterni</p>
        </div>

        <div class="form-section">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">Inserimento Dati Personali</h2>
            
            <div class="form-grid">
                <div class="form-column">
                    <h3><span class="icon">üë©</span>Dati della Paziente</h3>
                    <div class="form-group">
                        <label>Nome e Cognome <span class="required">*</span></label>
                        <input type="text" id="paziente-nome" placeholder="Es: Maria Rossi" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Luogo di nascita <span class="required">*</span></label>
                            <input type="text" id="paziente-luogo-nascita" placeholder="Es: Roma" required>
                        </div>
                        <div class="form-group">
                            <label>Data di nascita <span class="required">*</span></label>
                            <input type="date" id="paziente-data-nascita" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Professione <span class="optional-tag">Opzionale</span></label>
                        <input type="text" id="paziente-professione" placeholder="Es: Impiegata">
                    </div>
                    <div class="form-group">
                        <label>Indirizzo di residenza <span class="required">*</span></label>
                        <input type="text" id="paziente-residenza" placeholder="Es: Via Roma 1" required>
                    </div>
                    <div class="form-group">
                        <label>Citt√† e CAP <span class="required">*</span></label>
                        <input type="text" id="paziente-citta" placeholder="Es: Roma 00100" required>
                    </div>
                    <div class="form-group">
                        <label>Codice Fiscale <span class="optional-tag">Opzionale</span></label>
                        <input type="text" id="paziente-cf" placeholder="Es: RSSMRA80A01H501X" maxlength="16" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Telefono <span class="required">*</span></label>
                        <input type="tel" id="paziente-telefono" placeholder="Es: 333 1234567" required>
                    </div>
                    <div class="form-group">
                        <label>Email <span class="optional-tag">Opzionale</span></label>
                        <input type="email" id="paziente-email" placeholder="Es: maria.rossi@email.com">
                    </div>
                </div>

                <div class="form-column">
                    <h3><span class="icon">üë®</span>Dati del Partner</h3>
                    <div class="form-group">
                        <label>Nome e Cognome <span class="required">*</span></label>
                        <input type="text" id="partner-nome" placeholder="Es: Mario Bianchi" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Luogo di nascita <span class="required">*</span></label>
                            <input type="text" id="partner-luogo-nascita" placeholder="Es: Milano" required>
                        </div>
                        <div class="form-group">
                            <label>Data di nascita <span class="required">*</span></label>
                            <input type="date" id="partner-data-nascita" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Professione <span class="optional-tag">Opzionale</span></label>
                        <input type="text" id="partner-professione" placeholder="Es: Ingegnere">
                    </div>
                    <div class="form-group">
                        <label>Indirizzo di residenza <span class="required">*</span></label>
                        <input type="text" id="partner-residenza" placeholder="Es: Via Milano 2" required>
                    </div>
                    <div class="form-group">
                        <label>Citt√† e CAP <span class="required">*</span></label>
                        <input type="text" id="partner-citta" placeholder="Es: Roma 00100" required>
                    </div>
                    <div class="form-group">
                        <label>Codice Fiscale <span class="optional-tag">Opzionale</span></label>
                        <input type="text" id="partner-cf" placeholder="Es: BNCMRO80A01F205X" maxlength="16" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Telefono <span class="optional-tag">Opzionale</span></label>
                        <input type="tel" id="partner-telefono" placeholder="Es: 333 7654321">
                    </div>
                    <div class="form-group">
                        <label>Email <span class="optional-tag">Opzionale</span></label>
                        <input type="email" id="partner-email" placeholder="Es: mario.bianchi@email.com">
                    </div>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-top: 30px;">
                <h3 style="color: #2c3e50; margin-bottom: 20px;">üè• Informazioni sulla Procedura</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Medico responsabile</label>
                        <input type="text" id="medico-nome" placeholder="Es: Dott. Rossi">
                    </div>
                    <div class="form-group">
                        <label>Codice coppia</label>
                        <input type="text" id="codice-coppia" placeholder="Es: CP2024001">
                    </div>
                </div>
                <div class="form-group">
                    <label>Motivo della procedura/Causa infertilit√† <span class="optional-tag">Opzionale</span></label>
                    <textarea id="motivo-fecondazione" rows="2" placeholder="Es: Infertilit√† primaria"></textarea>
                </div>
            </div>
        </div>

        <div class="documents-section">
            <h2>üìÑ Seleziona i Documenti da Compilare</h2>
            <p style="text-align: center; color: #7f8c8d; margin-bottom: 25px;">
                Template integrati - Nessun file esterno richiesto
            </p>

            <div class="document-list">
                <div class="document-item" onclick="toggleDocument(this)">
                    <input type="checkbox" id="doc-privacy" checked>
                    <label for="doc-privacy">
                        <div class="document-code">MOD_01</div>
                        <div class="document-name">Consenso Privacy - GDPR</div>
                    </label>
                </div>

                <div class="document-item" onclick="toggleDocument(this)">
                    <input type="checkbox" id="doc-iui">
                    <label for="doc-iui">
                        <div class="document-code">MOD_04</div>
                        <div class="document-name">Consenso IUI (I Livello)</div>
                    </label>
                </div>

                <div class="document-item" onclick="toggleDocument(this)">
                    <input type="checkbox" id="doc-icsi">
                    <label for="doc-icsi">
                        <div class="document-code">MOD_05</div>
                        <div class="document-name">Consenso ICSI (II Livello)</div>
                    </label>
                </div>
            </div>
        </div>

        <div class="privacy-notice">
            <h3>üîí Privacy e Sicurezza</h3>
            <p>Tutti i dati vengono elaborati solo nel tuo browser e non vengono mai inviati a server esterni.<br>
            I documenti PDF vengono generati localmente e scaricati direttamente sul tuo dispositivo.</p>
        </div>

        <div class="actions">
            <button class="btn btn-primary" id="generateBtn" onclick="generaDocumenti()">
                üìÑ GENERA DOCUMENTI PDF
            </button>
            <button class="btn btn-secondary" onclick="resetForm()">
                üîÑ CANCELLA TUTTO
            </button>
        </div>

        <div id="message" class="message"></div>
    </div>

    <!-- Overlay di caricamento -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Generazione documenti in corso...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p style="margin-top: 20px; color: #7f8c8d;">Attendere prego, elaborazione in corso</p>
        </div>
    </div>

    <script>
        // Template integrati per GitHub Pages
        const templates = {
            'doc-privacy': `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        @page { size: A4; margin: 2cm; }
        body { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.4; color: #000; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { font-weight: bold; font-size: 14pt; margin-bottom: 10px; }
        .title { font-weight: bold; font-size: 13pt; text-decoration: underline; margin: 20px 0; text-align: center; }
        .content { text-align: justify; margin-bottom: 15px; }
        .signature-section { margin-top: 40px; display: flex; justify-content: space-between; }
        .signature-box { text-align: center; width: 45%; }
        .date-section { margin-top: 30px; text-align: right; }
        .bold { font-weight: bold; }
        .underline { text-decoration: underline; }
        .checkbox { display: inline-block; width: 12px; height: 12px; border: 1px solid #000; margin-right: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">CENTRO BIOFERTILITY</div>
        <div>Via del Centro Medico, 123 - 00100 Roma</div>
        <div>Tel. 06-1234567 - Email: info@biofertility.it</div>
    </div>

    <div class="title">CONSENSO AL TRATTAMENTO DEI DATI PERSONALI (ART. 7 D.LGS. 196/2003)</div>

    <div class="content">
        Il/La sottoscritto/a <span class="bold underline">[PAZIENTE_NOME]</span>, 
        nato/a a <span class="underline">[PAZIENTE_LUOGO_NASCITA]</span> 
        il <span class="underline">[PAZIENTE_DATA_NASCITA]</span>, 
        C.F. <span class="underline">[PAZIENTE_CF]</span>, 
        residente in <span class="underline">[PAZIENTE_RESIDENZA]</span>, 
        <span class="underline">[PAZIENTE_CITTA]</span>, 
        Tel. <span class="underline">[PAZIENTE_TELEFONO]</span>
    </div>

    <div class="content">
        e il/la sottoscritto/a <span class="bold underline">[PARTNER_NOME]</span>, 
        nato/a a <span class="underline">[PARTNER_LUOGO_NASCITA]</span> 
        il <span class="underline">[PARTNER_DATA_NASCITA]</span>, 
        C.F. <span class="underline">[PARTNER_CF]</span>, 
        residente in <span class="underline">[PARTNER_RESIDENZA]</span>, 
        <span class="underline">[PARTNER_CITTA]</span>, 
        Tel. <span class="underline">[PARTNER_TELEFONO]</span>
    </div>

    <div class="content"><span class="bold">DICHIARANO</span></div>

    <div class="content">
        di aver ricevuto ai sensi dell'art. 13 del D.Lgs. 196/2003 le informazioni relative al trattamento dei dati personali effettuato dal Centro Biofertility per le finalit√† connesse e strumentali alla prestazione sanitaria richiesta;
    </div>

    <div class="content">
        <span class="checkbox"></span> ACCONSENTONO al trattamento dei propri dati personali, compresi quelli sensibili, per le finalit√† di cui sopra;
    </div>

    <div class="content">
        <span class="checkbox"></span> ACCONSENTONO alla comunicazione dei dati per le finalit√† di cui sopra ai soggetti appartenenti alla categoria dei consulenti e collaboratori esterni, altri sanitari;
    </div>

    <div class="content">
        <span class="checkbox"></span> ACCONSENTONO alla comunicazione dei dati all'Istituto Superiore di Sanit√† e al Centro Nazionale Trapianti per le finalit√† previste dalla legge 40/2004;
    </div>

    <div class="content">
        Si informa inoltre che i dati potranno essere comunicati all'Autorit√† Giudiziaria qualora ne faccia richiesta per le proprie finalit√† istituzionali e che il loro conferimento √® obbligatorio per il conseguimento delle finalit√† sopra indicate.
    </div>

    <div class="content">
        Il sottoscritto dichiara di essere stato informato dei diritti di cui all'art. 7 del D.Lgs. 196/2003.
    </div>

    <div class="date-section">Data: <span class="underline">[DATA_ODIERNA]</span></div>

    <div class="signature-section">
        <div class="signature-box">
            <div>Firma del Paziente</div>
            <div style="margin-top: 30px; border-bottom: 1px solid #000; width: 200px; margin: 30px auto 0;"></div>
            <div style="margin-top: 5px;">[PAZIENTE_NOME]</div>
        </div>
        <div class="signature-box">
            <div>Firma del Partner</div>
            <div style="margin-top: 30px; border-bottom: 1px solid #000; width: 200px; margin: 30px auto 0;"></div>
            <div style="margin-top: 5px;">[PARTNER_NOME]</div>
        </div>
    </div>
</body>
</html>`,

            'doc-iui': `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        @page { size: A4; margin: 2cm; }
        body { font-family: 'Times New Roman', serif; font-size: 11pt; line-height: 1.3; color: #000; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { font-weight: bold; font-size: 14pt; margin-bottom: 10px; }
        .title { font-weight: bold; font-size: 13pt; text-align: center; margin: 20px 0; text-decoration: underline; }
        .content { text-align: justify; margin-bottom: 12px; }
        .patient-info { margin: 20px 0; border: 1px solid #000; padding: 15px; }
        .signature-section { margin-top: 40px; display: flex; justify-content: space-between; }
        .signature-box { text-align: center; width: 45%; }
        .date-section { margin-top: 30px; text-align: right; }
        .bold { font-weight: bold; }
        .underline { text-decoration: underline; }
        .list-item { margin: 8px 0 8px 20px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">CENTRO BIOFERTILITY</div>
        <div>Via del Centro Medico, 123 - 00100 Roma</div>
        <div>Tel. 06-1234567 - Email: info@biofertility.it</div>
    </div>

    <div class="title">CONSENSO INFORMATO PER INSEMINAZIONE INTRAUTERINA (IUI)</div>

    <div class="patient-info">
        <div><span class="bold">PAZIENTE:</span> <span class="underline">[PAZIENTE_NOME]</span></div>
        <div><span class="bold">Nata a:</span> <span class="underline">[PAZIENTE_LUOGO_NASCITA]</span> <span class="bold">il:</span> <span class="underline">[PAZIENTE_DATA_NASCITA]</span></div>
        <div><span class="bold">C.F.:</span> <span class="underline">[PAZIENTE_CF]</span></div>
        <div><span class="bold">Residente:</span> <span class="underline">[PAZIENTE_RESIDENZA], [PAZIENTE_CITTA]</span></div>
        <div style="margin-top: 15px;"><span class="bold">PARTNER:</span> <span class="underline">[PARTNER_NOME]</span></div>
        <div><span class="bold">Nato a:</span> <span class="underline">[PARTNER_LUOGO_NASCITA]</span> <span class="bold">il:</span> <span class="underline">[PARTNER_DATA_NASCITA]</span></div>
        <div><span class="bold">C.F.:</span> <span class="underline">[PARTNER_CF]</span></div>
        <div><span class="bold">Residente:</span> <span class="underline">[PARTNER_RESIDENZA], [PARTNER_CITTA]</span></div>
        <div style="margin-top: 15px;"><span class="bold">Medico responsabile:</span> <span class="underline">[MEDICO_NOME]</span></div>
        <div><span class="bold">Codice coppia:</span> <span class="underline">[CODICE_COPPIA]</span></div>
    </div>

    <div class="content"><span class="bold">DICHIARANO</span> di essere stati informati che:</div>

    <div class="content">
        <span class="bold">1. INDICAZIONI:</span> L'inseminazione intrauterina (IUI) √® indicata nei casi di:
        <div class="list-item">- Infertilit√† inspiegata</div>
        <div class="list-item">- Lieve alterazione dei parametri seminali</div>
        <div class="list-item">- Disturbi dell'ovulazione</div>
        <div class="list-item">- Infertilit√† cervicale</div>
        <div class="list-item">- Endometriosi lieve</div>
    </div>

    <div class="content">
        <span class="bold">2. PROCEDURA:</span> La IUI consiste nell'introduzione del liquido seminale, opportunamente trattato e concentrato, direttamente nella cavit√† uterina mediante un sottile catetere, nel periodo periovulatorio.
    </div>

    <div class="content">
        <span class="bold">3. RISULTATI:</span> Le percentuali di gravidanza per ciclo di trattamento sono circa del 15-20% per ciclo.
    </div>

    <div class="content">
        <span class="bold">4. RISCHI E COMPLICANZE:</span>
        <div class="list-item">- Gravidanze multiple (5-10%)</div>
        <div class="list-item">- Sindrome da iperstimolazione ovarica</div>
        <div class="list-item">- Possibili infezioni (rare)</div>
    </div>

    <div class="content">
        <span class="bold">MOTIVO DELLA PROCEDURA:</span> <span class="underline">[MOTIVO_FECONDAZIONE]</span>
    </div>

    <div class="content">
        Dopo aver ricevuto informazioni sui rischi e benefici della procedura, <span class="bold">ACCONSENTIAMO</span> liberamente al trattamento di IUI.
    </div>

    <div class="date-section">Data: <span class="underline">[DATA_ODIERNA]</span></div>

    <div class="signature-section">
        <div class="signature-box">
            <div>Firma della Paziente</div>
            <div style="margin-top: 30px; border-bottom: 1px solid #000; width: 200px; margin: 30px auto 0;"></div>
            <div style="margin-top: 5px;">[PAZIENTE_NOME]</div>
        </div>
        <div class="signature-box">
            <div>Firma del Partner</div>
            <div style="margin-top: 30px; border-bottom: 1px solid #000; width: 200px; margin: 30px auto 0;"></div>
            <div style="margin-top: 5px;">[PARTNER_NOME]</div>
        </div>
    </div>

    <div style="margin-top: 40px; text-align: center; border-top: 1px solid #000; padding-top: 20px;">
        <div><span class="bold">Timbro e Firma del Medico</span></div>
        <div style="margin-top: 40px; border-bottom: 1px solid #000; width: 300px; margin: 40px auto 0;"></div>
        <div style="margin-top: 5px;">Dott. [MEDICO_NOME]</div>
    </div>
</body>
</html>`,

            'doc-icsi': `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        @page { size: A4; margin: 2cm; }
        body { font-family: 'Times New Roman', serif; font-size: 11pt; line-height: 1.3; color: #000; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { font-weight: bold; font-size: 14pt; margin-bottom: 10px; }
        .title { font-weight: bold; font-size: 13pt; text-align: center; margin: 20px 0; text-decoration: underline; }
        .content { text-align: justify; margin-bottom: 12px; }
        .patient-info { margin: 20px 0; border: 1px solid #000; padding: 15px; }
        .signature-section { margin-top: 40px; display: flex; justify-content: space-between; }
        .signature-box { text-align: center; width: 45%; }
        .date-section { margin-top: 30px; text-align: right; }
        .bold { font-weight: bold; }
        .underline { text-decoration: underline; }
        .list-item { margin: 8px 0 8px 20px; }
        .warning-box { border: 2px solid #000; padding: 15px; margin: 20px 0; background-color: #f9f9f9; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">CENTRO BIOFERTILITY</div>
        <div>Via del Centro Medico, 123 - 00100 Roma</div>
        <div>Tel. 06-1234567 - Email: info@biofertility.it</div>
    </div>

    <div class="title">CONSENSO INFORMATO PER FECONDAZIONE IN VITRO CON INIEZIONE INTRACITOPLASMATICA (ICSI)</div>

    <div class="patient-info">
        <div><span class="bold">PAZIENTE:</span> <span class="underline">[PAZIENTE_NOME]</span></div>
        <div><span class="bold">Nata a:</span> <span class="underline">[PAZIENTE_LUOGO_NASCITA]</span> <span class="bold">il:</span> <span class="underline">[PAZIENTE_DATA_NASCITA]</span></div>
        <div><span class="bold">C.F.:</span> <span class="underline">[PAZIENTE_CF]</span></div>
        <div><span class="bold">Residente:</span> <span class="underline">[PAZIENTE_RESIDENZA], [PAZIENTE_CITTA]</span></div>
        <div style="margin-top: 15px;"><span class="bold">PARTNER:</span> <span class="underline">[PARTNER_NOME]</span></div>
        <div><span class="bold">Nato a:</span> <span class="underline">[PARTNER_LUOGO_NASCITA]</span> <span class="bold">il:</span> <span class="underline">[PARTNER_DATA_NASCITA]</span></div>
        <div><span class="bold">C.F.:</span> <span class="underline">[PARTNER_CF]</span></div>
        <div><span class="bold">Residente:</span> <span class="underline">[PARTNER_RESIDENZA], [PARTNER_CITTA]</span></div>
        <div style="margin-top: 15px;"><span class="bold">Medico responsabile:</span> <span class="underline">[MEDICO_NOME]</span></div>
        <div><span class="bold">Codice coppia:</span> <span class="underline">[CODICE_COPPIA]</span></div>
    </div>

    <div class="content"><span class="bold">DICHIARANO</span> di essere stati informati che:</div>

    <div class="content">
        <span class="bold">1. INDICAZIONI ALLA ICSI:</span> La ICSI √® indicata nei casi di:
        <div class="list-item">- Grave oligozoospermia (concentrazione < 5 milioni/ml)</div>
        <div class="list-item">- Astenozoospermia severa (motilit√† < 10%)</div>
        <div class="list-item">- Teratozoospermia severa (forme normali < 2%)</div>
        <div class="list-item">- Azoospermia (necessit√† di prelievo chirurgico)</div>
        <div class="list-item">- Fallimento di fertilizzazione con IVF convenzionale</div>
        <div class="list-item">- Presenza di anticorpi antispermatozoi</div>
    </div>

    <div class="content">
        <span class="bold">2. PROCEDURA:</span> La ICSI prevede:
        <div class="list-item">- Stimolazione ovarica controllata</div>
        <div class="list-item">- Prelievo ovocitario per via transvaginale</div>
        <div class="list-item">- Iniezione diretta del singolo spermatozoo nell'ovocita</div>
        <div class="list-item">- Coltura embrionale in laboratorio</div>
        <div class="list-item">- Transfer embrionale in utero</div>
    </div>

    <div class="content">
        <span class="bold">3. RISULTATI:</span> Le percentuali di gravidanza per ciclo sono circa del 30-40% nelle donne sotto i 35 anni, con declino progressivo dell'et√†.
    </div>

    <div class="content">
        <span class="bold">4. RISCHI E COMPLICANZE:</span>
        <div class="list-item">- Sindrome da iperstimolazione ovarica (1-5%)</div>
        <div class="list-item">- Gravidanze multiple (15-25%)</div>
        <div class="list-item">- Gravidanza ectopica (2-3%)</div>
        <div class="list-item">- Possibili malformazioni congenite (lievemente aumentate)</div>
        <div class="list-item">- Complicanze del prelievo ovocitario (rare)</div>
    </div>

    <div class="warning-box">
        <div class="bold">IMPORTANTE:</div>
        <div>Gli embrioni soprannumerari potranno essere crioconservati secondo la Legge 40/2004. √à necessario sottoscrivere specifico consenso per la crioconservazione.</div>
    </div>

    <div class="content">
        <span class="bold">MOTIVO DELLA PROCEDURA:</span> <span class="underline">[MOTIVO_FECONDAZIONE]</span>
    </div>

    <div class="content">
        Dopo aver ricevuto informazioni complete sui rischi e benefici della procedura, <span class="bold">ACCONSENTIAMO</span> liberamente al trattamento di ICSI.
    </div>

    <div class="date-section">Data: <span class="underline">[DATA_ODIERNA]</span></div>

    <div class="signature-section">
        <div class="signature-box">
            <div>Firma della Paziente</div>
            <div style="margin-top: 30px; border-bottom: 1px solid #000; width: 200px; margin: 30px auto 0;"></div>
            <div style="margin-top: 5px;">[PAZIENTE_NOME]</div>
        </div>
        <div class="signature-box">
            <div>Firma del Partner</div>
            <div style="margin-top: 30px; border-bottom: 1px solid #000; width: 200px; margin: 30px auto 0;"></div>
            <div style="margin-top: 5px;">[PARTNER_NOME]</div>
        </div>
    </div>

    <div style="margin-top: 40px; text-align: center; border-top: 1px solid #000; padding-top: 20px;">
        <div><span class="bold">Timbro e Firma del Medico</span></div>
        <div style="margin-top: 40px; border-bottom: 1px solid #000; width: 300px; margin: 40px auto 0;"></div>
        <div style="margin-top: 5px;">Dott. [MEDICO_NOME]</div>
    </div>
</body>
</html>`
        };

        // Funzioni del sistema (resto del codice JavaScript uguale al precedente)
        function toggleDocument(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                element.classList.add('selected');
            } else {
                element.classList.remove('selected');
            }
        }

        function raccogliDati() {
            const data = {
                paziente: {
                    nome: document.getElementById('paziente-nome').value.trim(),
                    luogoNascita: document.getElementById('paziente-luogo-nascita').value.trim(),
                    dataNascita: document.getElementById('paziente-data-nascita').value,
                    professione: document.getElementById('paziente-professione').value.trim(),
                    residenza: document.getElementById('paziente-residenza').value.trim(),
                    citta: document.getElementById('paziente-citta').value.trim(),
                    codiceFiscale: document.getElementById('paziente-cf').value.trim().toUpperCase(),
                    telefono: document.getElementById('paziente-telefono').value.trim(),
                    email: document.getElementById('paziente-email').value.trim()
                },
                partner: {
                    nome: document.getElementById('partner-nome').value.trim(),
                    luogoNascita: document.getElementById('partner-luogo-nascita').value.trim(),
                    dataNascita: document.getElementById('partner-data-nascita').value,
                    professione: document.getElementById('partner-professione').value.trim(),
                    residenza: document.getElementById('partner-residenza').value.trim(),
                    citta: document.getElementById('partner-citta').value.trim(),
                    codiceFiscale: document.getElementById('partner-cf').value.trim().toUpperCase(),
                    telefono: document.getElementById('partner-telefono').value.trim(),
                    email: document.getElementById('partner-email').value.trim()
                },
                procedura: {
                    medico: document.getElementById('medico-nome').value.trim(),
                    codiceCoppia: document.getElementById('codice-coppia').value.trim(),
                    motivo: document.getElementById('motivo-fecondazione').value.trim()
                }
            };

            const oggi = new Date();
            data.dataOdierna = oggi.toLocaleDateString('it-IT');
            data.annoOdierno = oggi.getFullYear().toString();

            return data;
        }

        function validaDati(data) {
            const campiObbligatori = [
                { campo: data.paziente.nome, nome: 'Nome paziente' },
                { campo: data.paziente.luogoNascita, nome: 'Luogo nascita paziente' },
                { campo: data.paziente.dataNascita, nome: 'Data nascita paziente' },
                { campo: data.paziente.residenza, nome: 'Residenza paziente' },
                { campo: data.paziente.citta, nome: 'Citt√† paziente' },
                { campo: data.paziente.telefono, nome: 'Telefono paziente' },
                { campo: data.partner.nome, nome: 'Nome partner' },
                { campo: data.partner.luogoNascita, nome: 'Luogo nascita partner' },
                { campo: data.partner.dataNascita, nome: 'Data nascita partner' },
                { campo: data.partner.residenza, nome: 'Residenza partner' },
                { campo: data.partner.citta, nome: 'Citt√† partner' }
            ];

            const campiMancanti = campiObbligatori.filter(item => !item.campo).map(item => item.nome);

            if (campiMancanti.length > 0) {
                throw new Error(`I seguenti campi sono obbligatori: ${campiMancanti.join(', ')}`);
            }
        }

        function formattaData(dataString) {
            if (!dataString) return '';
            const data = new Date(dataString);
            return data.toLocaleDateString('it-IT');
        }

        function compilaTemplate(template, data) {
            let contenutoCompilato = template;

            // Sostituzioni paziente
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_NOME\]/g, data.paziente.nome);
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_LUOGO_NASCITA\]/g, data.paziente.luogoNascita);
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_DATA_NASCITA\]/g, formattaData(data.paziente.dataNascita));
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_PROFESSIONE\]/g, data.paziente.professione || '');
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_RESIDENZA\]/g, data.paziente.residenza);
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_CITTA\]/g, data.paziente.citta);
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_CF\]/g, data.paziente.codiceFiscale);
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_TELEFONO\]/g, data.paziente.telefono);
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_EMAIL\]/g, data.paziente.email);

            // Sostituzioni partner
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_NOME\]/g, data.partner.nome);
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_LUOGO_NASCITA\]/g, data.partner.luogoNascita);
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_DATA_NASCITA\]/g, formattaData(data.partner.dataNascita));
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_PROFESSIONE\]/g, data.partner.professione || '');
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_RESIDENZA\]/g, data.partner.residenza);
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_CITTA\]/g, data.partner.citta);
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_CF\]/g, data.partner.codiceFiscale);
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_TELEFONO\]/g, data.partner.telefono);
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_EMAIL\]/g, data.partner.email);

            // Sostituzioni procedura
            contenutoCompilato = contenutoCompilato.replace(/\[MEDICO_NOME\]/g, data.procedura.medico);
            contenutoCompilato = contenutoCompilato.replace(/\[CODICE_COPPIA\]/g, data.procedura.codiceCoppia);
            contenutoCompilato = contenutoCompilato.replace(/\[MOTIVO_FECONDAZIONE\]/g, data.procedura.motivo);

            // Sostituzioni data
            contenutoCompilato = contenutoCompilato.replace(/\[DATA_ODIERNA\]/g, data.dataOdierna);
            contenutoCompilato = contenutoCompilato.replace(/\[ANNO_ODIERNO\]/g, data.annoOdierno);

            return contenutoCompilato;
        }

        async function generaPDFDaHTML(htmlContent, nomeFile) {
            try {
                const iframe = document.createElement('iframe');
                iframe.style.position = 'absolute';
                iframe.style.left = '-9999px';
                iframe.style.top = '0';
                iframe.style.width = '210mm';
                iframe.style.height = '297mm';
                iframe.style.border = 'none';
                document.body.appendChild(iframe);

                iframe.contentDocument.open();
                iframe.contentDocument.write(htmlContent);
                iframe.contentDocument.close();

                await new Promise(resolve => {
                    if (iframe.contentDocument.readyState === 'complete') {
                        resolve();
                    } else {
                        iframe.onload = resolve;
                    }
                });

                const canvas = await html2canvas(iframe.contentDocument.body, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 794,
                    height: 1123
                });

                document.body.removeChild(iframe);

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(nomeFile);
            } catch (error) {
                throw new Error(`Errore nella generazione del PDF: ${error.message}`);
            }
        }

        function aggiornaProgresso(percentuale) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percentuale + '%';
        }

        function mostraMessaggio(testo, tipo = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${tipo}`;
            messageDiv.textContent = testo;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        async function generaDocumenti() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const generateBtn = document.getElementById('generateBtn');
            
            try {
                generateBtn.disabled = true;
                loadingOverlay.style.display = 'flex';
                aggiornaProgresso(0);

                const data = raccogliDati();
                validaDati(data);

                const documentiSelezionati = [];
                const checkboxes = document.querySelectorAll('.document-item input[type="checkbox"]:checked');
                
                checkboxes.forEach(checkbox => {
                    const documentId = checkbox.id;
                    if (templates[documentId]) {
                        documentiSelezionati.push({
                            id: documentId,
                            nome: checkbox.parentElement.querySelector('.document-code').textContent
                        });
                    }
                });

                if (documentiSelezionati.length === 0) {
                    throw new Error('Seleziona almeno un documento da generare');
                }

                aggiornaProgresso(10);

                let documentiGenerati = 0;
                const totalDocumenti = documentiSelezionati.length;

                for (const doc of documentiSelezionati) {
                    try {
                        const template = templates[doc.id];
                        const contenutoCompilato = compilaTemplate(template, data);
                        const nomeFilePDF = `${doc.nome}_${data.paziente.nome.replace(/\s+/g, '_')}_${data.dataOdierna.replace(/\//g, '-')}.pdf`;
                        
                        await generaPDFDaHTML(contenutoCompilato, nomeFilePDF);
                        
                        documentiGenerati++;
                        const progresso = 10 + (documentiGenerati / totalDocumenti) * 80;
                        aggiornaProgresso(progresso);
                        
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                    } catch (error) {
                        console.error(`Errore nella generazione di ${doc.nome}:`, error);
                        mostraMessaggio(`Errore nella generazione di ${doc.nome}: ${error.message}`, 'error');
                    }
                }

                aggiornaProgresso(100);
                
                if (documentiGenerati > 0) {
                    mostraMessaggio(`‚úÖ Generati con successo ${documentiGenerati} documenti! Controlla la cartella Download.`, 'success');
                } else {
                    mostraMessaggio('‚ùå Nessun documento √® stato generato. Verifica i dati inseriti e riprova.', 'error');
                }

            } catch (error) {
                console.error('Errore durante la generazione:', error);
                mostraMessaggio(`‚ùå Errore: ${error.message}`, 'error');
            } finally {
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                    generateBtn.disabled = false;
                    aggiornaProgresso(0);
                }, 1000);
            }
        }

        function resetForm() {
            if (confirm('Sei sicuro di voler cancellare tutti i dati inseriti?')) {
                document.querySelectorAll('input, textarea, select').forEach(element => {
                    if (element.type === 'checkbox') {
                        element.checked = false;
                        element.closest('.document-item')?.classList.remove('selected');
                    } else {
                        element.value = '';
                    }
                });
                
                document.getElementById('doc-privacy').checked = true;
                document.getElementById('doc-privacy').closest('.document-item').classList.add('selected');
                
                mostraMessaggio('‚úÖ Form resettato con successo', 'success');
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.document-item input[type="checkbox"]:checked').forEach(checkbox => {
                checkbox.closest('.document-item').classList.add('selected');
            });

            document.querySelectorAll('.document-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('click', function(event) {
                    event.stopPropagation();
                    
                    if (this.checked) {
                        this.closest('.document-item').classList.add('selected');
                    } else {
                        this.closest('.document-item').classList.remove('selected');
                    }
                });
            });

            console.log('üåê Sistema Biofertility Web - GitHub Pages pronto!');
            console.log('üìã Template integrati:', Object.keys(templates));
        });
    </script>
</body>
</html>