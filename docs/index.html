<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro Biofertility - Compilazione Documenti PMA</title>
    <!-- Librerie CDN per GitHub Pages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .logo {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .form-section {
            background: white;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .form-column {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .form-column h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
        }

        .form-column h3 .icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .documents-section {
            background: white;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .documents-section h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8em;
        }

        .document-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .document-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .document-item:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .document-item.selected {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .document-item input[type="checkbox"] {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 22px;
            height: 22px;
            cursor: pointer;
        }

        .document-item label {
            display: block;
            cursor: pointer;
            padding-right: 40px;
        }

        .document-code {
            font-weight: bold;
            color: #3498db;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .document-name {
            color: #555;
            font-size: 0.95em;
        }

        .actions {
            text-align: center;
            margin: 30px 0;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .required {
            color: #e74c3c;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üè•</div>
            <h1>Centro Biofertility</h1>
            <p>Sistema Web di Compilazione Documenti PMA</p>
        </div>

        <div class="form-section">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">Inserimento Dati Personali</h2>
            
            <div class="form-grid">
                <div class="form-column">
                    <h3><span class="icon">üë©</span>Dati della Paziente</h3>
                    <div class="form-group">
                        <label>Nome e Cognome <span class="required">*</span></label>
                        <input type="text" id="paziente-nome" placeholder="Es: Maria Rossi" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Luogo di nascita <span class="required">*</span></label>
                            <input type="text" id="paziente-luogo-nascita" placeholder="Es: Roma" required>
                        </div>
                        <div class="form-group">
                            <label>Data di nascita <span class="required">*</span></label>
                            <input type="date" id="paziente-data-nascita" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Indirizzo di residenza <span class="required">*</span></label>
                        <input type="text" id="paziente-residenza" placeholder="Es: Via Roma 1" required>
                    </div>
                    <div class="form-group">
                        <label>Citt√† e CAP <span class="required">*</span></label>
                        <input type="text" id="paziente-citta" placeholder="Es: Roma 00100" required>
                    </div>
                    <div class="form-group">
                        <label>Codice Fiscale</label>
                        <input type="text" id="paziente-cf" placeholder="Es: RSSMRA80A01H501X" maxlength="16" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Telefono <span class="required">*</span></label>
                        <input type="tel" id="paziente-telefono" placeholder="Es: 333 1234567" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="paziente-email" placeholder="Es: maria@email.it">
                    </div>
                </div>

                <div class="form-column">
                    <h3><span class="icon">üë®</span>Dati del Partner</h3>
                    <div class="form-group">
                        <label>Nome e Cognome <span class="required">*</span></label>
                        <input type="text" id="partner-nome" placeholder="Es: Giuseppe Rossi" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Luogo di nascita <span class="required">*</span></label>
                            <input type="text" id="partner-luogo-nascita" placeholder="Es: Milano" required>
                        </div>
                        <div class="form-group">
                            <label>Data di nascita <span class="required">*</span></label>
                            <input type="date" id="partner-data-nascita" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Indirizzo di residenza <span class="required">*</span></label>
                        <input type="text" id="partner-residenza" placeholder="Es: Via Milano 2" required>
                    </div>
                    <div class="form-group">
                        <label>Citt√† e CAP <span class="required">*</span></label>
                        <input type="text" id="partner-citta" placeholder="Es: Milano 20100" required>
                    </div>
                    <div class="form-group">
                        <label>Codice Fiscale</label>
                        <input type="text" id="partner-cf" placeholder="Es: RSSGSF75B02F205Z" maxlength="16" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>Telefono <span class="required">*</span></label>
                        <input type="tel" id="partner-telefono" placeholder="Es: 333 7654321" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="partner-email" placeholder="Es: giuseppe@email.it">
                    </div>
                </div>
            </div>

            <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-top: 30px;">
                <h3 style="color: #2c3e50; margin-bottom: 20px;">üè• Informazioni sulla Procedura</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Medico responsabile</label>
                        <input type="text" id="medico-nome" placeholder="Es: Dott. Mario Rossi">
                    </div>
                    <div class="form-group">
                        <label>Numero iscrizione Ordine Medici</label>
                        <input type="text" id="numero-ordine" placeholder="Es: 12345">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Codice coppia</label>
                        <input type="text" id="codice-coppia" placeholder="Es: CP2024001">
                    </div>
                    <div class="form-group">
                        <label>Documento identit√† paziente</label>
                        <input type="text" id="paziente-documento" placeholder="Es: CI n. AB123456">
                    </div>
                </div>
                <div class="form-group">
                    <label>Motivo della procedura/Causa infertilit√†</label>
                    <textarea id="motivo-fecondazione" rows="2" placeholder="Es: Infertilit√† primaria"></textarea>
                </div>
            </div>
        </div>

        <div class="documents-section">
            <h2>üìÑ Seleziona i Documenti da Compilare</h2>
            <p style="text-align: center; color: #7f8c8d; margin-bottom: 25px;">
                Template integrati - Nessun file esterno richiesto
            </p>

            <div class="document-list">
                <div class="document-item" onclick="toggleDocument(this)">
                    <input type="checkbox" id="doc-privacy" checked>
                    <label for="doc-privacy">
                        <div class="document-code">MOD_01</div>
                        <div class="document-name">Consenso Privacy - GDPR</div>
                    </label>
                </div>

                <div class="document-item" onclick="toggleDocument(this)">
                    <input type="checkbox" id="doc-iui">
                    <label for="doc-iui">
                        <div class="document-code">MOD_04</div>
                        <div class="document-name">Consenso IUI (I Livello)</div>
                    </label>
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" id="generateBtn" onclick="generaDocumenti()">
                üìÑ GENERA DOCUMENTI PDF
            </button>
            <button class="btn btn-secondary" onclick="resetForm()">
                üîÑ CANCELLA TUTTO
            </button>
        </div>

        <div id="message" class="message"></div>
    </div>

    <!-- Overlay di caricamento -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Generazione documenti in corso...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p style="margin-top: 20px; color: #7f8c8d;">Attendere prego, elaborazione in corso</p>
        </div>
    </div>

    <script>
        // Template integrati per GitHub Pages - VERSIONE CORRETTA
        const templates = {
            'doc-privacy': `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        @page { size: A4; margin: 2.5cm 2cm; }
        @media print { 
            body { -webkit-print-color-adjust: exact; }
            .document-container { page-break-inside: avoid; }
            .patient-info { page-break-inside: avoid; }
            .section-header { page-break-after: avoid; }
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 11pt; line-height: 1.5; color: #2c3e50; background: #fff; margin: 0; padding: 0; min-height: 100vh; }
        .document-container { max-width: 210mm; margin: 0 auto; background: white; }
        .header { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 25px 30px; text-align: center; }
        .logo { font-weight: 700; font-size: 20pt; margin-bottom: 8px; letter-spacing: 1px; }
        .header-info { font-size: 10pt; opacity: 0.95; margin-top: 10px; }
        .content-wrapper { padding: 30px; }
        .title { font-weight: 700; font-size: 16pt; color: #2c3e50; text-align: center; margin: 0 0 30px 0; padding: 15px 0; border-bottom: 3px solid #3498db; }
        .section-header { background: #f8f9fa; padding: 12px 20px; margin: 25px -15px 15px -15px; border-left: 4px solid #3498db; font-weight: 600; color: #2c3e50; border-radius: 0 8px 8px 0; }
        .patient-info { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #dee2e6; border-radius: 12px; padding: 25px; margin: 20px 0; position: relative; }
        .patient-row { display: flex; margin-bottom: 12px; align-items: center; }
        .patient-label { font-weight: 600; color: #495057; min-width: 120px; margin-right: 15px; }
        .patient-value { flex: 1; padding: 8px 12px; background: white; border: 1px solid #ced4da; border-radius: 6px; font-weight: 500; }
        .content { text-align: justify; margin-bottom: 18px; line-height: 1.6; color: #495057; }
        .gdpr-section { background: #e8f4f8; border: 2px solid #17a2b8; border-radius: 12px; padding: 20px; margin: 20px 0; }
        .rights-list { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; border: 1px solid #dee2e6; }
        .rights-item { padding: 8px 0; border-bottom: 1px solid #f8f9fa; display: flex; align-items: center; }
        .rights-item::before { content: '‚úì'; color: #28a745; font-weight: bold; margin-right: 10px; width: 20px; }
        .signature-section { margin-top: 50px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; padding-top: 30px; border-top: 2px solid #dee2e6; }
        .signature-box { text-align: center; padding: 20px; border: 2px dashed #ced4da; border-radius: 12px; background: #f8f9fa; }
        .signature-line { margin: 30px auto 10px; width: 200px; height: 2px; background: #ced4da; border-radius: 2px; }
        .bold { font-weight: 700; color: #2c3e50; }
        .underline { border-bottom: 2px solid #3498db; padding: 2px 6px; border-radius: 4px; }
        .footer-info { background: #2c3e50; color: white; padding: 20px 30px; font-size: 9pt; text-align: center; margin-top: 40px; }
    </style>
</head>
<body>
    <div class="document-container">
        <div class="header">
            <div class="logo">üè• CENTRO BIOFERTILITY</div>
            <div class="header-info">
                <div>üìç Via del Centro Medico, 123 - 00100 Roma</div>
                <div>üìû 06-1234567 | ‚úâÔ∏è info@biofertility.it</div>
                <div style="margin-top: 8px; font-weight: 600;">Autorizzazione Regionale n. 12345</div>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="title">INFORMATIVA E CONSENSO AL TRATTAMENTO DEI DATI PERSONALI<br>
            <span style="font-size: 12pt; font-weight: 500;">(Art. 13-14 GDPR UE 2016/679)</span></div>

            <div class="section-header">üìã DATI IDENTIFICATIVI DEI PAZIENTI</div>
            
            <div class="patient-info">
                <div style="font-weight: 700; margin-bottom: 15px; color: #3498db;">üë© PAZIENTE</div>
                <div class="patient-row">
                    <span class="patient-label">Nome completo:</span>
                    <span class="patient-value underline">[PAZIENTE_NOME]</span>
                </div>
                <div class="patient-row">
                    <span class="patient-label">Nato/a a:</span>
                    <span class="patient-value underline">[PAZIENTE_LUOGO_NASCITA]</span>
                    <span class="patient-label" style="margin-left: 20px;">il:</span>
                    <span class="patient-value underline">[PAZIENTE_DATA_NASCITA]</span>
                </div>
                <div class="patient-row">
                    <span class="patient-label">Codice Fiscale:</span>
                    <span class="patient-value underline">[PAZIENTE_CF]</span>
                </div>
                <div class="patient-row">
                    <span class="patient-label">Residenza:</span>
                    <span class="patient-value underline">[PAZIENTE_RESIDENZA], [PAZIENTE_CITTA]</span>
                </div>
                
                <div style="font-weight: 700; margin: 20px 0 15px 0; color: #3498db;">üë® PARTNER</div>
                <div class="patient-row">
                    <span class="patient-label">Nome completo:</span>
                    <span class="patient-value underline">[PARTNER_NOME]</span>
                </div>
                <div class="patient-row">
                    <span class="patient-label">Nato/a a:</span>
                    <span class="patient-value underline">[PARTNER_LUOGO_NASCITA]</span>
                    <span class="patient-label" style="margin-left: 20px;">il:</span>
                    <span class="patient-value underline">[PARTNER_DATA_NASCITA]</span>
                </div>
                <div class="patient-row">
                    <span class="patient-label">Codice Fiscale:</span>
                    <span class="patient-value underline">[PARTNER_CF]</span>
                </div>
                <div class="patient-row">
                    <span class="patient-label">Residenza:</span>
                    <span class="patient-value underline">[PARTNER_RESIDENZA], [PARTNER_CITTA]</span>
                </div>
            </div>

            <div class="section-header">üîí INFORMATIVA SUL TRATTAMENTO DEI DATI PERSONALI</div>
            
            <div class="gdpr-section">
                <div class="content">
                    <span class="bold">TITOLARE DEL TRATTAMENTO:</span> Centro Biofertility S.r.l., Via del Centro Medico, 123 - 00100 Roma
                </div>
                
                <div class="content">
                    <span class="bold">FINALIT√Ä DEL TRATTAMENTO:</span> Erogazione prestazioni sanitarie PMA, gestione cartella clinica, adempimenti di legge.
                </div>

                <div class="rights-list">
                    <div class="rights-item">Erogazione di prestazioni sanitarie di Procreazione Medicalmente Assistita</div>
                    <div class="rights-item">Gestione della cartella clinica e documentazione sanitaria</div>
                    <div class="rights-item">Adempimenti di legge (CNT, ISS, Regione)</div>
                    <div class="rights-item">Gestione amministrativa e fatturazione</div>
                </div>
            </div>

            <div class="section-header">‚úÖ CONSENSO AL TRATTAMENTO</div>
            
            <div class="content">
                I sottoscritti <span class="bold">ACCONSENTONO</span> al trattamento dei propri dati personali per le finalit√† indicate.
            </div>

            <div style="margin: 30px 0; text-align: right; font-weight: 600;">
                Roma, <span class="underline">[DATA_ODIERNA]</span>
            </div>

            <div class="signature-section">
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div style="font-weight: 600; margin-top: 10px;">[PAZIENTE_NOME]</div>
                </div>
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div style="font-weight: 600; margin-top: 10px;">[PARTNER_NOME]</div>
                </div>
            </div>
        </div>

        <div class="footer-info">
            <div>üìÑ Documento generato automaticamente - Sistema PMA Centro Biofertility</div>
            <div style="margin-top: 8px; font-size: 8pt;">Conforme a GDPR UE 2016/679 e normativa italiana vigente</div>
        </div>
    </div>
</body>
</html>`,

            'doc-iui': `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        @page { size: A4; margin: 2.5cm 2cm; }
        @media print { 
            body { -webkit-print-color-adjust: exact; }
            .document-container { page-break-inside: avoid; }
            .patient-info { page-break-inside: avoid; }
            .section-header { page-break-after: avoid; }
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 11pt; line-height: 1.5; color: #2c3e50; background: #fff; margin: 0; padding: 0; min-height: 100vh; }
        .document-container { max-width: 210mm; margin: 0 auto; background: white; }
        .header { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 25px 30px; text-align: center; }
        .logo { font-weight: 700; font-size: 20pt; margin-bottom: 8px; letter-spacing: 1px; }
        .header-info { font-size: 10pt; opacity: 0.95; margin-top: 10px; }
        .content-wrapper { padding: 30px; }
        .title { font-weight: 700; font-size: 16pt; color: #2c3e50; text-align: center; margin: 0 0 30px 0; padding: 15px 0; border-bottom: 3px solid #27ae60; }
        .section-header { background: #e8f8f5; padding: 12px 20px; margin: 25px -15px 15px -15px; border-left: 4px solid #27ae60; font-weight: 600; color: #2c3e50; border-radius: 0 8px 8px 0; }
        .patient-info { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #dee2e6; border-radius: 12px; padding: 25px; margin: 20px 0; }
        .patient-row { display: flex; margin-bottom: 12px; align-items: center; }
        .patient-label { font-weight: 600; color: #495057; min-width: 120px; margin-right: 15px; }
        .patient-value { flex: 1; padding: 8px 12px; background: white; border: 1px solid #ced4da; border-radius: 6px; font-weight: 500; }
        .content { text-align: justify; margin-bottom: 18px; line-height: 1.6; color: #495057; }
        .indication-list { background: white; border-radius: 8px; padding: 20px; margin: 15px 0; border: 1px solid #dee2e6; }
        .indication-item { padding: 8px 0; border-bottom: 1px solid #f8f9fa; display: flex; align-items: center; }
        .indication-item::before { content: '‚Ä¢'; color: #27ae60; font-weight: bold; margin-right: 10px; width: 20px; font-size: 14pt; }
        .success-rate { background: #e8f4f8; border: 2px solid #17a2b8; border-radius: 12px; padding: 20px; margin: 20px 0; text-align: center; }
        .signature-section { margin-top: 50px; display: grid; grid-template-columns: 1fr 1fr; gap: 40px; padding-top: 30px; border-top: 2px solid #dee2e6; }
        .signature-box { text-align: center; padding: 20px; border: 2px dashed #ced4da; border-radius: 12px; background: #f8f9fa; }
        .signature-line { margin: 30px auto 10px; width: 200px; height: 2px; background: #ced4da; border-radius: 2px; }
        .bold { font-weight: 700; color: #2c3e50; }
        .underline { border-bottom: 2px solid #27ae60; padding: 2px 6px; border-radius: 4px; }
        .footer-info { background: #2c3e50; color: white; padding: 20px 30px; font-size: 9pt; text-align: center; margin-top: 40px; }
    </style>
</head>
<body>
    <div class="document-container">
        <div class="header">
            <div class="logo">üè• CENTRO BIOFERTILITY</div>
            <div class="header-info">
                <div>üìç Via del Centro Medico, 123 - 00100 Roma</div>
                <div>üìû 06-1234567 | ‚úâÔ∏è info@biofertility.it</div>
                <div style="margin-top: 8px; font-weight: 600;">Centro di I¬∞ Livello PMA</div>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="title">CONSENSO INFORMATO PER INSEMINAZIONE INTRAUTERINA (IUI)<br>
            <span style="font-size: 12pt; font-weight: 500;">Tecnica di Procreazione Medicalmente Assistita di I¬∞ Livello</span></div>

            <div class="section-header">üë• DATI IDENTIFICATIVI DEI PAZIENTI</div>
            
            <div class="patient-info">
                <div style="font-weight: 700; margin-bottom: 15px; color: #27ae60;">üë© PAZIENTE</div>
                <div class="patient-row">
                    <span class="patient-label">Nome completo:</span>
                    <span class="patient-value underline">[PAZIENTE_NOME]</span>
                </div>
                <div class="patient-row">
                    <span class="patient-label">Nato/a a:</span>
                    <span class="patient-value underline">[PAZIENTE_LUOGO_NASCITA]</span>
                    <span class="patient-label" style="margin-left: 20px;">il:</span>
                    <span class="patient-value underline">[PAZIENTE_DATA_NASCITA]</span>
                </div>
                <div class="patient-row">
                    <span class="patient-label">Residenza:</span>
                    <span class="patient-value underline">[PAZIENTE_RESIDENZA], [PAZIENTE_CITTA]</span>
                </div>
                
                <div style="font-weight: 700; margin: 20px 0 15px 0; color: #27ae60;">üë® PARTNER</div>
                <div class="patient-row">
                    <span class="patient-label">Nome completo:</span>
                    <span class="patient-value underline">[PARTNER_NOME]</span>
                </div>
                <div class="patient-row">
                    <span class="patient-label">Nato/a a:</span>
                    <span class="patient-value underline">[PARTNER_LUOGO_NASCITA]</span>
                    <span class="patient-label" style="margin-left: 20px;">il:</span>
                    <span class="patient-value underline">[PARTNER_DATA_NASCITA]</span>
                </div>
                <div class="patient-row">
                    <span class="patient-label">Residenza:</span>
                    <span class="patient-value underline">[PARTNER_RESIDENZA], [PARTNER_CITTA]</span>
                </div>
                
                <div style="font-weight: 700; margin: 20px 0 15px 0; color: #27ae60;">üë®‚Äç‚öïÔ∏è INFORMAZIONI CLINICHE</div>
                <div class="patient-row">
                    <span class="patient-label">Medico responsabile:</span>
                    <span class="patient-value underline">Dott. [MEDICO_NOME]</span>
                </div>
                <div class="patient-row">
                    <span class="patient-label">Codice coppia:</span>
                    <span class="patient-value underline">[CODICE_COPPIA]</span>
                </div>
            </div>

            <div class="section-header">üéØ INDICAZIONI CLINICHE</div>
            
            <div class="content">
                L'Inseminazione Intrauterina (IUI) √® indicata per:
            </div>
            
            <div class="indication-list">
                <div class="indication-item">Infertilit√† inspiegata</div>
                <div class="indication-item">Alterazioni lievi dei parametri seminali</div>
                <div class="indication-item">Disturbi dell'ovulazione</div>
                <div class="indication-item">Fattore cervicale</div>
                <div class="indication-item">Endometriosi lieve</div>
            </div>

            <div class="section-header">üî¨ DESCRIZIONE DELLA PROCEDURA</div>
            
            <div class="content">
                La IUI consiste nell'introduzione del liquido seminale, preparato in laboratorio, direttamente nella cavit√† uterina mediante catetere sterile nel periodo periovulatorio.
            </div>

            <div class="success-rate">
                <div class="bold" style="font-size: 14pt; margin-bottom: 10px;">üìä PERCENTUALI DI SUCCESSO</div>
                <div>Gravidanza per ciclo: <span class="bold">15-20%</span></div>
                <div style="font-size: 9pt; color: #6c757d; margin-top: 8px;">Variabile in base all'et√† e alla diagnosi</div>
            </div>

            <div class="content">
                <span class="bold">MOTIVO SPECIFICO:</span>
                <div style="margin: 10px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #27ae60;">
                    <span class="underline">[MOTIVO_FECONDAZIONE]</span>
                </div>
            </div>

            <div class="section-header">‚úÖ CONSENSO AL TRATTAMENTO</div>
            
            <div class="content">
                I sottoscritti, dopo aver ricevuto informazioni complete, <span class="bold">ACCONSENTONO</span> al trattamento di IUI.
            </div>

            <div style="margin: 30px 0; text-align: right; font-weight: 600;">
                Roma, <span class="underline">[DATA_ODIERNA]</span>
            </div>

            <div class="signature-section">
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div style="font-weight: 600; margin-top: 10px;">[PAZIENTE_NOME]</div>
                </div>
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div style="font-weight: 600; margin-top: 10px;">[PARTNER_NOME]</div>
                </div>
            </div>
        </div>

        <div class="footer-info">
            <div>üìÑ Consenso Informato IUI - Sistema PMA Centro Biofertility</div>
            <div style="margin-top: 8px; font-size: 8pt;">Conforme a Legge 40/2004 e normativa vigente</div>
        </div>
    </div>
</body>
</html>`
        };

        // Funzioni del sistema
        function toggleDocument(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                element.classList.add('selected');
            } else {
                element.classList.remove('selected');
            }
        }

        function raccogliDati() {
            const data = {
                paziente: {
                    nome: document.getElementById('paziente-nome').value.trim(),
                    luogoNascita: document.getElementById('paziente-luogo-nascita').value.trim(),
                    dataNascita: document.getElementById('paziente-data-nascita').value,
                    residenza: document.getElementById('paziente-residenza').value.trim(),
                    citta: document.getElementById('paziente-citta').value.trim(),
                    codiceFiscale: document.getElementById('paziente-cf').value.trim().toUpperCase(),
                    telefono: document.getElementById('paziente-telefono').value.trim(),
                    email: document.getElementById('paziente-email').value.trim()
                },
                partner: {
                    nome: document.getElementById('partner-nome').value.trim(),
                    luogoNascita: document.getElementById('partner-luogo-nascita').value.trim(),
                    dataNascita: document.getElementById('partner-data-nascita').value,
                    residenza: document.getElementById('partner-residenza').value.trim(),
                    citta: document.getElementById('partner-citta').value.trim(),
                    codiceFiscale: document.getElementById('partner-cf').value.trim().toUpperCase(),
                    telefono: document.getElementById('partner-telefono').value.trim(),
                    email: document.getElementById('partner-email').value.trim()
                },
                procedura: {
                    medico: document.getElementById('medico-nome').value.trim(),
                    numeroOrdine: document.getElementById('numero-ordine').value.trim(),
                    codiceCoppia: document.getElementById('codice-coppia').value.trim(),
                    motivo: document.getElementById('motivo-fecondazione').value.trim(),
                    documento: document.getElementById('paziente-documento').value.trim()
                }
            };

            const oggi = new Date();
            data.dataOdierna = oggi.toLocaleDateString('it-IT');
            data.annoOdierno = oggi.getFullYear().toString();

            return data;
        }

        function validaDati(data) {
            const campiObbligatori = [
                { campo: data.paziente.nome, nome: 'Nome paziente' },
                { campo: data.paziente.luogoNascita, nome: 'Luogo nascita paziente' },
                { campo: data.paziente.dataNascita, nome: 'Data nascita paziente' },
                { campo: data.paziente.residenza, nome: 'Residenza paziente' },
                { campo: data.paziente.citta, nome: 'Citt√† paziente' },
                { campo: data.paziente.telefono, nome: 'Telefono paziente' },
                { campo: data.partner.nome, nome: 'Nome partner' },
                { campo: data.partner.luogoNascita, nome: 'Luogo nascita partner' },
                { campo: data.partner.dataNascita, nome: 'Data nascita partner' },
                { campo: data.partner.residenza, nome: 'Residenza partner' },
                { campo: data.partner.citta, nome: 'Citt√† partner' }
            ];

            const campiMancanti = campiObbligatori.filter(item => !item.campo).map(item => item.nome);

            if (campiMancanti.length > 0) {
                throw new Error(`I seguenti campi sono obbligatori: ${campiMancanti.join(', ')}`);
            }
        }

        function formattaData(dataString) {
            if (!dataString) return '';
            const data = new Date(dataString);
            return data.toLocaleDateString('it-IT');
        }

        function compilaTemplate(template, data) {
            let contenutoCompilato = template;

            // Sostituzioni paziente
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_NOME\]/g, data.paziente.nome);
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_LUOGO_NASCITA\]/g, data.paziente.luogoNascita);
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_DATA_NASCITA\]/g, formattaData(data.paziente.dataNascita));
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_RESIDENZA\]/g, data.paziente.residenza);
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_CITTA\]/g, data.paziente.citta);
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_CF\]/g, data.paziente.codiceFiscale);
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_TELEFONO\]/g, data.paziente.telefono);
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_EMAIL\]/g, data.paziente.email);

            // Sostituzioni partner
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_NOME\]/g, data.partner.nome);
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_LUOGO_NASCITA\]/g, data.partner.luogoNascita);
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_DATA_NASCITA\]/g, formattaData(data.partner.dataNascita));
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_RESIDENZA\]/g, data.partner.residenza);
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_CITTA\]/g, data.partner.citta);
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_CF\]/g, data.partner.codiceFiscale);
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_TELEFONO\]/g, data.partner.telefono);
            contenutoCompilato = contenutoCompilato.replace(/\[PARTNER_EMAIL\]/g, data.partner.email);

            // Sostituzioni procedura
            contenutoCompilato = contenutoCompilato.replace(/\[MEDICO_NOME\]/g, data.procedura.medico);
            contenutoCompilato = contenutoCompilato.replace(/\[NUMERO_ORDINE\]/g, data.procedura.numeroOrdine);
            contenutoCompilato = contenutoCompilato.replace(/\[CODICE_COPPIA\]/g, data.procedura.codiceCoppia);
            contenutoCompilato = contenutoCompilato.replace(/\[MOTIVO_FECONDAZIONE\]/g, data.procedura.motivo);
            contenutoCompilato = contenutoCompilato.replace(/\[PAZIENTE_DOCUMENTO\]/g, data.procedura.documento);

            // Sostituzioni data
            contenutoCompilato = contenutoCompilato.replace(/\[DATA_ODIERNA\]/g, data.dataOdierna);
            contenutoCompilato = contenutoCompilato.replace(/\[ANNO_ODIERNO\]/g, data.annoOdierno);

            return contenutoCompilato;
        }

        async function generaPDFDaHTML(htmlContent, nomeFile) {
            try {
                const iframe = document.createElement('iframe');
                iframe.style.position = 'absolute';
                iframe.style.left = '-9999px';
                iframe.style.width = '210mm';
                iframe.style.height = '297mm';
                iframe.style.border = 'none';
                document.body.appendChild(iframe);

                iframe.contentDocument.open();
                iframe.contentDocument.write(htmlContent);
                iframe.contentDocument.close();

                await new Promise(resolve => {
                    if (iframe.contentDocument.readyState === 'complete') {
                        // Attendiamo un po' di pi√π per essere sicuri che tutto sia renderizzato
                        setTimeout(resolve, 1000);
                    } else {
                        iframe.onload = () => setTimeout(resolve, 1000);
                    }
                });

                const canvas = await html2canvas(iframe.contentDocument.body, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    width: 794,
                    height: iframe.contentDocument.body.scrollHeight,
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: 794,
                    windowHeight: iframe.contentDocument.body.scrollHeight
                });

                document.body.removeChild(iframe);

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                // Prima pagina
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Pagine aggiuntive se necessario
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(nomeFile);
            } catch (error) {
                throw new Error(`Errore nella generazione del PDF: ${error.message}`);
            }
        }

        function aggiornaProgresso(percentuale) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percentuale + '%';
        }

        function mostraMessaggio(testo, tipo = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message ${tipo}`;
            messageDiv.textContent = testo;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        async function generaDocumenti() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const generateBtn = document.getElementById('generateBtn');
            
            try {
                generateBtn.disabled = true;
                loadingOverlay.style.display = 'flex';
                aggiornaProgresso(0);

                const data = raccogliDati();
                validaDati(data);

                const documentiSelezionati = [];
                const checkboxes = document.querySelectorAll('.document-item input[type="checkbox"]:checked');
                
                checkboxes.forEach(checkbox => {
                    const documentId = checkbox.id;
                    if (templates[documentId]) {
                        documentiSelezionati.push({
                            id: documentId,
                            nome: checkbox.parentElement.querySelector('.document-name').textContent,
                            codice: checkbox.parentElement.querySelector('.document-code').textContent
                        });
                    }
                });

                if (documentiSelezionati.length === 0) {
                    throw new Error('Seleziona almeno un documento da generare');
                }

                for (let i = 0; i < documentiSelezionati.length; i++) {
                    const doc = documentiSelezionati[i];
                    aggiornaProgresso((i + 1) / documentiSelezionati.length * 100);

                    const templateCompilato = compilaTemplate(templates[doc.id], data);
                    const nomeFile = `${doc.codice}_${doc.nome.replace(/[^a-zA-Z0-9]/g, '_')}_${data.dataOdierna.replace(/\//g, '-')}.pdf`;
                    
                    await generaPDFDaHTML(templateCompilato, nomeFile);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                mostraMessaggio(`‚úÖ ${documentiSelezionati.length} documento/i generato/i con successo!`, 'success');

            } catch (error) {
                console.error('Errore:', error);
                mostraMessaggio(`‚ùå Errore: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                loadingOverlay.style.display = 'none';
                aggiornaProgresso(0);
            }
        }

        function resetForm() {
            if (confirm('Sei sicuro di voler cancellare tutti i dati inseriti?')) {
                document.querySelectorAll('input, textarea, select').forEach(element => {
                    if (element.type === 'checkbox') {
                        element.checked = false;
                        element.closest('.document-item')?.classList.remove('selected');
                    } else {
                        element.value = '';
                    }
                });
                
                document.getElementById('doc-privacy').checked = true;
                document.getElementById('doc-privacy').closest('.document-item').classList.add('selected');
                
                mostraMessaggio('‚úÖ Form resettato con successo', 'success');
            }
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.document-item input[type="checkbox"]:checked').forEach(checkbox => {
                checkbox.closest('.document-item').classList.add('selected');
            });

            document.querySelectorAll('.document-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('click', function(event) {
                    event.stopPropagation();
                    
                    if (this.checked) {
                        this.closest('.document-item').classList.add('selected');
                    } else {
                        this.closest('.document-item').classList.remove('selected');
                    }
                });
            });

            console.log('üåê Sistema Biofertility Web - VERSIONE CORRETTA pronta!');
        });
    </script>
</body>
</html>